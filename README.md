# QuantAlpha Engine

> å·¥ä¸šçº§å› å­ç ”å‘ä¸å›æµ‹æ¡†æ¶ Â· ä»¿ç…§ WorldQuant å·¥ä½œæµ

---

## ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä¾èµ–å®‰è£…](#ä¾èµ–å®‰è£…)
- [æ¨¡å—è¯¦è§£](#æ¨¡å—è¯¦è§£)
  - [MockDataGenerator â€” æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨](#1-mockdatagenerator--æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨)
  - [AlphaOps â€” ç®—å­åº“](#2-alphaops--ç®—å­åº“)
    - [æ—¶åºç±»ç®—å­](#æ—¶åºç±»-time-series)
    - [æˆªé¢ç±»ç®—å­](#æˆªé¢ç±»-cross-sectional)
    - [ç‰¹æ®Šç±»ç®—å­](#ç‰¹æ®Šç±»-special)
  - [VectorEngine â€” å›æµ‹å¼•æ“](#3-vectorengine--å›æµ‹å¼•æ“)
  - [BacktestResult â€” å›æµ‹ç»“æœå¯¹è±¡](#4-backtestresult--å›æµ‹ç»“æœå¯¹è±¡)
  - [Performance â€” ç»©æ•ˆæŒ‡æ ‡è®¡ç®—](#5-performance--ç»©æ•ˆæŒ‡æ ‡è®¡ç®—)
  - [Report â€” å¯è§†åŒ–æŠ¥å‘Š](#6-report--å¯è§†åŒ–æŠ¥å‘Š)
- [æŒ‡æ ‡è¯´æ˜](#æŒ‡æ ‡è¯´æ˜)
- [ä½¿ç”¨çœŸå®æ•°æ®](#ä½¿ç”¨çœŸå®æ•°æ®)
- [å› å­æ„é€ ç¤ºä¾‹é›†](#å› å­æ„é€ ç¤ºä¾‹é›†)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®ç®€ä»‹

QuantAlpha Engine æ˜¯ä¸€ä¸ªé¢å‘é‡åŒ–ç ”ç©¶å‘˜çš„**å› å­å›æµ‹ä¸€ç«™å¼æ¡†æ¶**ï¼Œæ ¸å¿ƒè®¾è®¡ç†å¿µä»¿ç…§ WorldQuant Alpha å¹³å°å·¥ä½œæµï¼š

- ç”¨**åµŒå¥—ç®—å­**æè¿°å› å­é€»è¾‘ï¼Œé€»è¾‘æ¸…æ™°ï¼Œå¯è¯»æ€§å¼º
- **å…¨å‘é‡åŒ–**è®¡ç®—ï¼Œæ‰€æœ‰æ“ä½œåŸºäº pandas/numpy çŸ©é˜µè¿ç®—ï¼Œæ— æ˜¾å¼è‚¡ç¥¨å¾ªç¯
- ä¸¥æ ¼é˜²æ­¢**æœªæ¥å‡½æ•°ï¼ˆLook-ahead biasï¼‰**ï¼šT æ—¥å› å­å€¼ â†’ T+1 æ—¥å®é™…æ”¶ç›Š
- æ”¯æŒ**åœç‰Œã€æ¶¨è·Œåœ**è‡ªåŠ¨è¿‡æ»¤ï¼Œæ‰£é™¤çœŸå®äº¤æ˜“æˆæœ¬
- ä¸€è¡Œä»£ç  `.run()` å¾—åˆ°å®Œæ•´ç»©æ•ˆæŠ¥å‘Š

**æœ€ç®€ä½¿ç”¨æµç¨‹ï¼š**

```python
from quant_alpha_engine import MockDataGenerator
from quant_alpha_engine.ops import AlphaOps as op
from quant_alpha_engine.backtest import VectorEngine

# 1. å‡†å¤‡æ•°æ®
data = MockDataGenerator(n_stocks=100, n_days=504).generate()

# 2. ç”¨ç®—å­æ„é€ å› å­ï¼ˆæ”¯æŒä»»æ„åµŒå¥—ï¼‰
factor = op.Rank(op.Ts_Delta(data.close, 20))

# 3. ä¸€è¡Œè°ƒç”¨å›æµ‹
result = VectorEngine(
    factor=factor, close=data.close,
    is_suspended=data.is_suspended, is_limit=data.is_limit
).run()

# 4. æŸ¥çœ‹ç»“æœ
result.print_summary()   # æ§åˆ¶å°æ‰“å°æŒ‡æ ‡è¡¨æ ¼
result.plot()            # ç”Ÿæˆ 6 å­å›¾åˆ†ææŠ¥å‘Š
```

---

## ç›®å½•ç»“æ„

```
quant_alpha_engine/
â”œâ”€â”€ __init__.py                    # ç»Ÿä¸€å¯¼å‡ºï¼Œä¸€è¡Œå¯¼å…¥æ‰€æœ‰æ¨¡å—
â”œâ”€â”€ data/
â”‚   â””â”€â”€ mock_generator.py          # æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨
â”œâ”€â”€ ops/
â”‚   â””â”€â”€ alpha_ops.py               # ç®—å­åº“ï¼ˆ13ä¸ªç®—å­ï¼‰
â”œâ”€â”€ backtest/
â”‚   â”œâ”€â”€ performance.py             # ç»©æ•ˆæŒ‡æ ‡è®¡ç®—
â”‚   â””â”€â”€ vector_engine.py           # çŸ©é˜µå¼å‡€å€¼å›æµ‹å¼•æ“
â””â”€â”€ visualization/
    â””â”€â”€ report.py                  # Matplotlib 6å­å›¾æŠ¥å‘Š

QuantAlpha_Demo.ipynb              # Jupyter å®Œæ•´æ¼”ç¤ºï¼ˆæ¨èå…¥å£ï¼‰
demo.py                            # Python è„šæœ¬ç‰ˆæ¼”ç¤º
requirements.txt                   # ä¾èµ–åˆ—è¡¨
```

---

## å¿«é€Ÿå¼€å§‹

**æ–¹å¼ä¸€ï¼ˆæ¨èï¼‰ï¼šç›´æ¥æ‰“å¼€ Jupyter Notebook**

```bash
jupyter notebook QuantAlpha_Demo.ipynb
```

æŒ‰é¡ºåºæ‰§è¡Œå„å•å…ƒæ ¼ï¼Œå³å¯çœ‹åˆ°å®Œæ•´æ¼”ç¤ºã€‚

**æ–¹å¼äºŒï¼šè¿è¡Œ Python è„šæœ¬**

```bash
python demo.py
```

---

## ä¾èµ–å®‰è£…

```bash
pip install -r requirements.txt
```

| ä¾èµ–åŒ… | æœ€ä½ç‰ˆæœ¬ | ç”¨é€” |
|--------|----------|------|
| numpy | 1.24 | çŸ©é˜µè¿ç®— |
| pandas | 2.0 | DataFrame æ ¸å¿ƒæ“ä½œ |
| matplotlib | 3.7 | å›¾è¡¨ç»˜åˆ¶ |
| seaborn | 0.12 | çƒ­åŠ›å›¾ï¼ˆå¯é€‰ï¼Œæ— åˆ™é™çº§ï¼‰ |
| scipy | 1.10 | KDEã€æ­£æ€æ‹Ÿåˆã€OLS |

> **æ³¨æ„**ï¼šseaborn ä¸ºå¯é€‰ä¾èµ–ã€‚è‹¥æœªå®‰è£…ï¼Œæœˆåº¦çƒ­åŠ›å›¾å°†ä½¿ç”¨ matplotlib çš„ `imshow` æ›¿ä»£ï¼ŒåŠŸèƒ½ä¸å—å½±å“ã€‚

---

## æ¨¡å—è¯¦è§£

---

### 1. MockDataGenerator â€” æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå™¨

**å¯¼å…¥è·¯å¾„ï¼š** `from quant_alpha_engine import MockDataGenerator`

ç”¨äºåœ¨æ²¡æœ‰çœŸå®æ•°æ®æ—¶å¿«é€Ÿç”Ÿæˆæµ‹è¯•ç”¨å¸‚åœºæ•°æ®ã€‚åŸºäº**å‡ ä½•å¸ƒæœ—è¿åŠ¨ï¼ˆGBMï¼‰**å åŠ è¡Œä¸šå…±åŒå› å­ï¼Œæ¨¡æ‹ŸçœŸå®å¸‚åœºçš„è¡Œä¸šç›¸å…³ç»“æ„ã€åœç‰Œã€æ¶¨è·Œåœç­‰ç‰¹å¾ã€‚

#### æ„é€ å‚æ•°

```python
MockDataGenerator(
    n_stocks        = 100,          # è‚¡ç¥¨æ•°é‡
    n_days          = 504,          # äº¤æ˜“æ—¥æ€»æ•°ï¼ˆ504 â‰ˆ 2å¹´ï¼‰
    n_industries    = 10,           # è¡Œä¸šæ•°é‡
    start_date      = '2022-01-01', # èµ·å§‹æ—¥æœŸï¼ˆè·³è¿‡å‘¨æœ«ï¼‰
    seed            = 42,           # éšæœºç§å­ï¼ŒNone åˆ™æ¯æ¬¡ç»“æœä¸åŒ
    mu              = 0.08,         # æ‰€æœ‰è‚¡ç¥¨å¹´åŒ–æ¼‚ç§»ç‡çš„åŸºå‡†å€¼
    sigma           = 0.30,         # æ‰€æœ‰è‚¡ç¥¨å¹´åŒ–æ³¢åŠ¨ç‡çš„åŸºå‡†å€¼
    suspended_ratio = 0.04,         # æœ‰åœç‰Œå†å²çš„è‚¡ç¥¨å æ¯”ï¼ˆçº¦4%ï¼‰
    limit_pct       = 0.099,        # æ¶¨è·Œåœè§¦å‘é˜ˆå€¼ï¼ˆ|æ¶¨è·Œå¹…| >= 9.9%ï¼‰
)
```

#### å‚æ•°è¯¦è§£

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `n_stocks` | int | 100 | ç”Ÿæˆçš„è‚¡ç¥¨æ•°é‡ã€‚è¶Šå¤§ï¼Œæˆªé¢è¦†ç›–è¶Šå…¨ï¼Œä½†è¿ç®—ç•¥æ…¢ |
| `n_days` | int | 504 | äº¤æ˜“æ—¥æ•°ã€‚252 â‰ˆ 1å¹´ï¼Œ504 â‰ˆ 2å¹´ï¼Œ756 â‰ˆ 3å¹´ |
| `n_industries` | int | 10 | è¡Œä¸šæ•°é‡ã€‚æ¯ä¸ªè¡Œä¸šè‡³å°‘åˆ†é… 2 åªè‚¡ç¥¨ |
| `start_date` | str | `'2022-01-01'` | èµ·å§‹æ—¥æœŸã€‚è‡ªåŠ¨è·³è¿‡å‘¨æœ«ï¼Œä¸å¤„ç†èŠ‚å‡æ—¥ |
| `seed` | int \| None | 42 | å›ºå®šéšæœºç§å­ä¿è¯å¤ç°æ€§ï¼›è®¾ä¸º `None` æ¯æ¬¡éšæœº |
| `mu` | float | 0.08 | å¹´åŒ–æ¼‚ç§»ç‡åŸºå‡†ï¼ˆæ¯åªè‚¡ç¥¨åœ¨æ­¤åŸºç¡€ä¸Š Â±4% éšæœºåç§»ï¼‰|
| `sigma` | float | 0.30 | å¹´åŒ–æ³¢åŠ¨ç‡åŸºå‡†ï¼ˆæ¯åªè‚¡ç¥¨åœ¨æ­¤åŸºç¡€ä¸Š Â±10% éšæœºåç§»ï¼‰|
| `suspended_ratio` | float | 0.04 | å†å²åœç‰Œè‚¡ç¥¨å æ¯”ï¼Œæ¯åªåœç‰Œè‚¡æœ‰ 1~3 æ®µè¿ç»­åœç‰ŒæœŸ |
| `limit_pct` | float | 0.099 | æ¶¨è·Œåœåˆ¤æ–­é˜ˆå€¼ï¼ŒAè‚¡é€šå¸¸ä¸º 0.099ï¼ˆ9.9%ï¼‰|

#### æ–¹æ³•

```python
data = gen.generate()   # ç”Ÿæˆå¹¶è¿”å› MockData å¯¹è±¡
```

#### MockData å¯¹è±¡å­—æ®µ

`generate()` è¿”å›ä¸€ä¸ª `MockData` æ•°æ®ç±»ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | å½¢çŠ¶ | è¯´æ˜ |
|------|------|------|------|
| `data.close` | DataFrame | T Ã— N | æ”¶ç›˜ä»·ï¼Œåœç‰ŒæœŸé—´ä¸º NaN |
| `data.open` | DataFrame | T Ã— N | å¼€ç›˜ä»· |
| `data.high` | DataFrame | T Ã— N | æœ€é«˜ä»· |
| `data.low` | DataFrame | T Ã— N | æœ€ä½ä»· |
| `data.volume` | DataFrame | T Ã— N | æˆäº¤é‡ï¼ˆæ‰‹ï¼Œ100è‚¡/æ‰‹ï¼‰ï¼Œä¸æ³¢åŠ¨æ­£ç›¸å…³ |
| `data.industry` | Series | N | è¡Œä¸šæ˜ å°„ï¼Œ`index=è‚¡ç¥¨ä»£ç , values=è¡Œä¸šåç§°` |
| `data.is_suspended` | DataFrame | T Ã— N | åœç‰ŒçŸ©é˜µï¼Œ`True` è¡¨ç¤ºå½“æ—¥åœç‰Œ |
| `data.is_limit` | DataFrame | T Ã— N | æ¶¨è·ŒåœçŸ©é˜µï¼Œ`True` è¡¨ç¤ºè§¦å‘æ¶¨åœæˆ–è·Œåœ |

æ‰€æœ‰ DataFrame çš„ `index` ä¸º `DatetimeIndex`ï¼ˆäº¤æ˜“æ—¥ï¼‰ï¼Œ`columns` ä¸ºè‚¡ç¥¨ä»£ç ï¼ˆå¦‚ `SH600000`ï¼‰ã€‚

#### ä½¿ç”¨ç¤ºä¾‹

```python
from quant_alpha_engine import MockDataGenerator

# åŸºç¡€ç”¨æ³•
gen  = MockDataGenerator(n_stocks=100, n_days=504, seed=42)
data = gen.generate()

close    = data.close        # æ”¶ç›˜ä»·çŸ©é˜µ
volume   = data.volume       # æˆäº¤é‡çŸ©é˜µ
industry = data.industry     # è¡Œä¸šæ˜ å°„ Series
is_susp  = data.is_suspended # åœç‰ŒçŸ©é˜µ
is_limit = data.is_limit     # æ¶¨è·ŒåœçŸ©é˜µ

# æŸ¥çœ‹æ•°æ®
print(data.close.shape)                 # (504, 100)
print(data.close.index[:3])             # DatetimeIndex å‰3ä¸ªäº¤æ˜“æ—¥
print(data.industry.value_counts())     # å„è¡Œä¸šè‚¡ç¥¨æ•°é‡åˆ†å¸ƒ

# ç†Šå¸‚æ¨¡æ‹Ÿï¼ˆé«˜æ³¢åŠ¨ã€è´Ÿæ¼‚ç§»ï¼‰
bear_gen  = MockDataGenerator(mu=-0.05, sigma=0.45, seed=100)
bear_data = bear_gen.generate()
```

---

### 2. AlphaOps â€” ç®—å­åº“

**å¯¼å…¥è·¯å¾„ï¼š** `from quant_alpha_engine.ops import AlphaOps as op`

æ‰€æœ‰ç®—å­å‡ä¸º**é™æ€æ–¹æ³•**ï¼Œè¾“å…¥è¾“å‡ºå‡ä¸º `pd.DataFrame`ï¼ˆIndex=æ—¶é—´ï¼ŒColumns=è‚¡ç¥¨ï¼‰ï¼Œæ”¯æŒä»»æ„åµŒå¥—ç»„åˆã€‚

**ç»Ÿä¸€çº¦å®šï¼š**
- æ‰€æœ‰ DataFrame é¡»æŒ‰æ—¶é—´å‡åºæ’åˆ—
- çª—å£ä¸è¶³æ—¶è¿”å› `NaN`ï¼ˆä¸ä¼šæŠ¥é”™ï¼‰
- æˆªé¢æ“ä½œè‡ªåŠ¨å¿½ç•¥ NaNï¼ˆä¸å‚ä¸æ’å/ç»Ÿè®¡ï¼‰

---

#### æ—¶åºç±» (Time-Series)

æ—¶åºç®—å­åœ¨**å•åªè‚¡ç¥¨çš„æ—¶é—´åºåˆ—**ä¸Šæ“ä½œï¼Œé€åˆ—ç‹¬ç«‹è®¡ç®—ã€‚

---

##### `Ts_Sum(df, window)` â€” æ»‘åŠ¨çª—å£æ±‚å’Œ

```python
result = op.Ts_Sum(df, window)
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `df` | DataFrame | è¾“å…¥çŸ©é˜µï¼ˆæ—¶é—´ Ã— è‚¡ç¥¨ï¼‰ |
| `window` | int | æ±‚å’Œçª—å£å¤§å°ï¼ˆå¤©æ•°ï¼‰ï¼Œå¦‚ `5` è¡¨ç¤ºè¿‡å»5å¤©ä¹‹å’Œ |

**è¿”å›ï¼š** ä¸ `df` åŒå½¢çŠ¶çš„ DataFrameï¼Œå‰ `window-1` è¡Œä¸º NaNã€‚

```python
# 5æ—¥æˆäº¤é‡ä¹‹å’Œï¼ˆè¡¡é‡è¿‘æœŸæ´»è·ƒåº¦ï¼‰
vol_sum5 = op.Ts_Sum(data.volume, 5)

# 20æ—¥ä»·æ ¼æ¶¨è·Œä¹‹å’Œï¼ˆå¤šç©ºåŠ›é‡ç§¯ç´¯ï¼‰
pnl_sum = op.Ts_Sum(op.Ts_Delta(data.close, 1), 20)
```

---

##### `Ts_Mean(df, window)` â€” æ»‘åŠ¨çª—å£å‡å€¼ï¼ˆç§»åŠ¨å¹³å‡ï¼‰

```python
result = op.Ts_Mean(df, window)
```

| å‚æ•° | è¯´æ˜ |
|------|------|
| `window` | å‡å€¼çª—å£å¤§å°ï¼ˆå¤©æ•°ï¼‰ |

```python
ma20 = op.Ts_Mean(data.close, 20)   # 20æ—¥ç§»åŠ¨å¹³å‡
# ä»·æ ¼åç¦»ç§»åŠ¨å‡çº¿çš„ç¨‹åº¦
deviation = data.close / op.Ts_Mean(data.close, 20) - 1
```

---

##### `Ts_Max(df, window)` / `Ts_Min(df, window)` â€” æ»‘åŠ¨çª—å£æå€¼

```python
result = op.Ts_Max(df, window)
result = op.Ts_Min(df, window)
```

```python
# 20æ—¥æœ€é«˜ä»·ï¼ˆç”¨äºè®¡ç®—ä»·æ ¼ä½ç½®ï¼‰
high20 = op.Ts_Max(data.high, 20)
low20  = op.Ts_Min(data.low, 20)

# ä»·æ ¼åœ¨è¿‘20æ—¥åŒºé—´å†…çš„ä½ç½®ï¼ˆ0=æœ€ä½ç‚¹ï¼Œ1=æœ€é«˜ç‚¹ï¼‰
price_pos = (data.close - low20) / (high20 - low20 + 1e-8)
```

---

##### `Ts_Std(df, window)` â€” æ»‘åŠ¨çª—å£æ ‡å‡†å·®

```python
result = op.Ts_Std(df, window)
```

```python
# 20æ—¥ä»·æ ¼æ³¢åŠ¨ç‡ï¼ˆç”¨äºæ„é€ ä½æ³¢åŠ¨å› å­ï¼‰
vol20 = op.Ts_Std(data.close.pct_change(), 20)
# ä½æ³¢åŠ¨å› å­ï¼šæ³¢åŠ¨ç‡è¶Šä½ï¼Œæ’åè¶Šé å‰
low_vol_factor = op.Rank(-vol20)
```

---

##### `Ts_Delta(df, period)` â€” N æ—¥ä»·å·®ï¼ˆåŠ¨é‡/åè½¬æ ¸å¿ƒï¼‰

è®¡ç®— `df - df.shift(period)`ï¼Œå³å½“å‰å€¼ä¸ N å¤©å‰çš„å·®ã€‚

```python
result = op.Ts_Delta(df, period)
```

| å‚æ•° | è¯´æ˜ |
|------|------|
| `period` | å›çœ‹æœŸæ•°ï¼ˆå¤©æ•°ï¼‰ |

```python
# 5æ—¥ä»·æ ¼å˜åŒ–ï¼ˆçŸ­æœŸåŠ¨é‡ï¼‰
delta5  = op.Ts_Delta(data.close, 5)

# 20æ—¥ä»·æ ¼å˜åŒ–ï¼ˆä¸­æœŸåŠ¨é‡ï¼‰
delta20 = op.Ts_Delta(data.close, 20)

# åè½¬å› å­ï¼šè¿‘æœŸè·Œå¹…è¶Šå¤§ â†’ æ’åè¶Šé å‰ï¼ˆå€¼è¶Šå°å¯¹åº”æ’åè¶Šé«˜ï¼‰
reversal = op.Rank(-op.Ts_Delta(data.close, 5))
```

---

##### `Ts_Delay(df, period)` â€” æ•°æ®æ»å N å¤©

ç­‰ä»·äº `df.shift(period)`ã€‚å¸¸ç”¨äºæ„é€ "Nå¤©å‰çš„å€¼"å‚ä¸è®¡ç®—ã€‚

```python
result = op.Ts_Delay(df, period)
```

```python
# ä¸Šå‘¨åŒä¸€å¤©çš„ä»·æ ¼
close_5d_ago = op.Ts_Delay(data.close, 5)

# æ„é€ ç›¸å¯¹å¼ºåº¦ï¼šå½“å‰ä»·æ ¼ / 20å¤©å‰ä»·æ ¼
rs = data.close / op.Ts_Delay(data.close, 20)
```

---

##### `Ts_Rank(df, window)` â€” æ—¶åºçª—å£å†…ç™¾åˆ†æ¯”æ’å

å½“å‰å€¼åœ¨è¿‡å» `window` ä¸ªè§‚æµ‹å€¼ä¸­çš„**åˆ†ä½æ•°æ’å**ï¼ˆè¶Šé«˜è¡¨ç¤ºå½“å‰å¤„äºå†å²é«˜ä½ï¼‰ã€‚

```python
result = op.Ts_Rank(df, window)   # è¿”å›å€¼åŸŸ [0, 1]
```

| å‚æ•° | è¯´æ˜ |
|------|------|
| `window` | å†å²å›çœ‹çª—å£ï¼ˆå¤©æ•°ï¼‰ |

**ä¸æˆªé¢ `Rank` çš„åŒºåˆ«ï¼š**
- `Ts_Rank`ï¼šå•åªè‚¡ç¥¨åœ¨è‡ªèº«å†å²ä¸­çš„æ’åï¼ˆæ—¶é—´ç»´åº¦ï¼‰
- `Rank`ï¼šæ‰€æœ‰è‚¡ç¥¨åœ¨åŒä¸€æˆªé¢æ—¥æœŸä¸­çš„æ’åï¼ˆæˆªé¢ç»´åº¦ï¼‰

```python
# å½“å‰æˆäº¤é‡åœ¨è¿‘20å¤©ä¸­çš„å†å²åˆ†ä½ï¼ˆ>0.8 è¡¨ç¤ºé‡èƒ½å¤„äºå†å²é«˜ä½ï¼‰
vol_rank = op.Ts_Rank(data.volume, 20)

# ä»·æ ¼å¤„äºå†å²é«˜ä½ + æˆäº¤é‡ä¹Ÿå¤„äºé«˜ä½ â†’ æ”¾é‡åˆ›æ–°é«˜
breakout = op.Rank(op.Ts_Rank(data.close, 60) + op.Ts_Rank(data.volume, 20))
```

> âš ï¸ `Ts_Rank` å†…éƒ¨ä½¿ç”¨ `rolling.apply`ï¼Œå¯¹è¶…å¤§çŸ©é˜µï¼ˆ>500åªè‚¡ç¥¨ï¼‰é€Ÿåº¦è¾ƒæ…¢ï¼Œå»ºè®® `window` ä¸è¶…è¿‡ 60ã€‚

---

##### `Ts_Corr(df1, df2, window)` â€” æ»šåŠ¨ç›¸å…³ç³»æ•°

è®¡ç®—ä¸¤ä¸ªåŒå½¢çŠ¶ DataFrame åœ¨æ»šåŠ¨çª—å£å†…çš„é€åˆ— **Pearson ç›¸å…³ç³»æ•°**ã€‚

```python
result = op.Ts_Corr(df1, df2, window)   # è¿”å›å€¼åŸŸ [-1, 1]
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `df1` | DataFrame | ç¬¬ä¸€ä¸ªè¾“å…¥çŸ©é˜µ |
| `df2` | DataFrame | ç¬¬äºŒä¸ªè¾“å…¥çŸ©é˜µï¼Œé¡»ä¸ df1 å½¢çŠ¶ç›¸åŒ |
| `window` | int | æ»šåŠ¨çª—å£å¤§å° |

> ä¸¤ä¸ª DataFrame é¡»æœ‰ç›¸åŒçš„ index å’Œ columnsï¼›è‹¥ä¸ä¸€è‡´ï¼Œæ¡†æ¶è‡ªåŠ¨å–äº¤é›†å¯¹é½ã€‚

```python
# è¿‡å»10å¤©ï¼Œæˆäº¤é‡ä¸ä»·æ ¼çš„ç›¸å…³ç³»æ•°
# æ­£å€¼ï¼šé‡ä»·åŒå‘ï¼ˆæ”¾é‡ä¸Šæ¶¨ï¼‰ï¼›è´Ÿå€¼ï¼šé‡ä»·èƒŒç¦»ï¼ˆç¼©é‡ä¸Šæ¶¨ï¼‰
vol_price_corr = op.Ts_Corr(data.volume, data.close, 10)

# é‡ä»·èƒŒç¦»å› å­ï¼šè´Ÿç›¸å…³ï¼ˆç¼©é‡ä¸Šæ¶¨ï¼‰æ’åé å‰
factor = op.Rank(-vol_price_corr)

# è¡Œä¸šä¸­æ€§åŒ–åä½¿ç”¨
factor_neut = op.Neutralize(factor, data.industry)
```

---

#### æˆªé¢ç±» (Cross-Sectional)

æˆªé¢ç®—å­åœ¨**åŒä¸€æ—¥æœŸçš„æ‰€æœ‰è‚¡ç¥¨**ä¸Šæ“ä½œï¼ˆæ¨ªå‘æ“ä½œï¼‰ï¼Œé€è¡Œç‹¬ç«‹è®¡ç®—ã€‚

---

##### `Rank(df)` â€” æˆªé¢ç™¾åˆ†æ¯”æ’å

å¯¹æ¯ä¸ªæ—¥æœŸæˆªé¢ï¼Œå°†æ‰€æœ‰è‚¡ç¥¨çš„å› å­å€¼åšç™¾åˆ†æ¯”æ’åã€‚

```python
result = op.Rank(df)   # è¿”å›å€¼åŸŸ [0, 1]
```

- å€¼è¶Šå¤§ â†’ è¯¥è‚¡ç¥¨åœ¨å½“æ—¥å› å­å€¼ä¸­æ’åè¶Šé å‰
- NaN å€¼ä¸å‚ä¸æ’åï¼Œå¯¹åº”ä½ç½®ä»è¿”å› NaN
- é€‚åˆæ¶ˆé™¤å› å­é‡çº²ï¼Œç»Ÿä¸€åŒ–ä¸åŒå› å­çš„å°ºåº¦

```python
# æœ€å¸¸ç”¨çš„ç”¨æ³•ï¼šå¯¹åŸå§‹å› å­åšæˆªé¢æ’åï¼Œå»é™¤æå€¼å½±å“
raw_factor = op.Ts_Delta(data.close, 20)
factor     = op.Rank(raw_factor)        # å€¼å‹ç¼©åˆ° [0,1]ï¼Œå‡åŒ€åˆ†å¸ƒ

# åµŒå¥—ï¼šå…ˆæ—¶åºå¤„ç†ï¼Œå†æˆªé¢æ’å
factor = op.Rank(op.Ts_Mean(data.volume, 5) / op.Ts_Mean(data.volume, 20))
```

---

##### `ZScore(df)` â€” æˆªé¢ Z-Score æ ‡å‡†åŒ–

å¯¹æ¯ä¸ªæ—¥æœŸæˆªé¢ï¼Œåšæ ‡å‡†åŒ–ï¼š`(value - æˆªé¢å‡å€¼) / æˆªé¢æ ‡å‡†å·®`ã€‚

```python
result = op.ZScore(df)   # æˆªé¢å‡å€¼â‰ˆ0ï¼Œæ ‡å‡†å·®â‰ˆ1
```

- é€‚åˆéœ€è¦ä¿ç•™å› å­çº¿æ€§ç»“æ„ï¼ˆè€Œä¸æ˜¯æ’åä¿¡æ¯ï¼‰çš„åœºæ™¯
- å¯¹æç«¯å€¼æ•æ„Ÿï¼ˆä¸ `Rank` ä¸åŒï¼Œæå€¼ä¼šè¢«ä¿ç•™ï¼‰
- è‡³å°‘éœ€è¦ 2 ä¸ªé NaN å€¼ï¼Œå¦åˆ™è¿”å› NaN

```python
# æ ‡å‡†åŒ–åçš„æˆäº¤é‡åç¦»åº¦
vol_zscore = op.ZScore(data.volume)

# ä¸ Rank çš„åŒºåˆ«
factor_rank   = op.Rank(raw_factor)    # å‡åŒ€åˆ†å¸ƒï¼Œå¯¹æå€¼ä¸æ•æ„Ÿ
factor_zscore = op.ZScore(raw_factor)  # æ­£æ€åˆ†å¸ƒï¼Œä¿ç•™æå€¼ä¿¡æ¯
```

---

##### `Scale(df, a=1.0)` â€” æˆªé¢ç»å¯¹å€¼ç¼©æ”¾

å°†æ¯ä¸ªæˆªé¢çš„å› å­ç»å¯¹å€¼ä¹‹å’Œç¼©æ”¾è‡³ `a`ï¼š`sum(|factor_i|) = a`ã€‚

```python
result = op.Scale(df, a=1.0)
```

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `a` | 1.0 | ç›®æ ‡ç»å¯¹å€¼ä¹‹å’Œ |

**å…¸å‹ç”¨é€”ï¼š** å°†å› å­å€¼ç›´æ¥ç”¨ä½œæŒä»“æƒé‡ï¼ˆå¤šç©ºç»„åˆï¼‰æ—¶ï¼Œ`Scale(factor, 1)` ç¡®ä¿æ€»æƒé‡ç»å¯¹å€¼ä¸º 1ï¼Œå³å¤šå¤´ + ç©ºå¤´æ€»æ æ†ä¸º 1ã€‚

```python
# å°†å› å­ç›´æ¥è½¬ä¸ºå¤šç©ºæƒé‡ï¼ˆæ­£å€¼åšå¤šï¼Œè´Ÿå€¼åšç©ºï¼Œæ€»æ æ†=1ï¼‰
weights_factor = op.Scale(op.ZScore(raw_factor), a=1.0)

# æ€»ç»å¯¹æƒé‡éªŒè¯
print(weights_factor.abs().sum(axis=1).mean())  # â‰ˆ 1.0
```

---

#### ç‰¹æ®Šç±» (Special)

---

##### `Decay_Linear(df, d)` â€” çº¿æ€§è¡°å‡åŠ æƒç§»åŠ¨å¹³å‡

WorldQuant å¹³å°çš„æ ¸å¿ƒç®—å­ä¹‹ä¸€ã€‚å¯¹è¿‡å» `d` å¤©æ•°æ®åšçº¿æ€§åŠ æƒå¹³å‡ï¼Œ**è¶Šè¿‘çš„æ•°æ®æƒé‡è¶Šå¤§**ã€‚

```python
result = op.Decay_Linear(df, d)
```

| å‚æ•° | è¯´æ˜ |
|------|------|
| `d` | è¡°å‡çª—å£å¤§å°ï¼ˆå¤©æ•°ï¼‰ |

**æƒé‡åˆ†é…ï¼š**
- d å¤©å‰çš„æ•°æ®æƒé‡ä¸º **1**ï¼ˆæœ€å°ï¼‰
- d-1 å¤©å‰æƒé‡ä¸º **2**
- ...
- 1 å¤©å‰æƒé‡ä¸º **d-1**
- å½“å¤©æƒé‡ä¸º **d**ï¼ˆæœ€å¤§ï¼‰
- æ‰€æœ‰æƒé‡å½’ä¸€åŒ–åæ±‚åŠ æƒå‡å€¼

**ä¸æ™®é€šç§»åŠ¨å¹³å‡çš„åŒºåˆ«ï¼š**
- `Ts_Mean(df, d)`ï¼šç­‰æƒå‡å€¼ï¼Œæ¯å¤©æƒé‡ = 1/d
- `Decay_Linear(df, d)`ï¼šçº¿æ€§åŠ æƒï¼Œæœ€æ–°æ•°æ®æƒé‡æœ€é«˜ï¼Œä¿¡å·è¡°å‡æ›´å¹³æ»‘

```python
# å¯¹åŠ¨é‡ä¿¡å·åšçº¿æ€§è¡°å‡å¹³æ»‘ï¼ˆå‡å°‘ä¿¡å·æŠ–åŠ¨ï¼‰
raw_signal = op.Rank(op.Ts_Delta(data.close, 5))
smooth_signal = op.Decay_Linear(raw_signal, d=5)

# åµŒå¥—ï¼šå…ˆæˆªé¢æ’åï¼Œå†çº¿æ€§è¡°å‡ï¼Œå†é‡æ–°æ’å
factor = op.Rank(
    op.Decay_Linear(
        op.Rank(op.Ts_Delta(data.close, 10)),
        d=5
    )
)
```

---

##### `Neutralize(df, group_data)` â€” è¡Œä¸šä¸­æ€§åŒ–

é€šè¿‡ OLS æ®‹å·®æ³•ï¼Œ**å‰”é™¤å› å­ä¸­çš„è¡Œä¸šå…±æ€§æˆåˆ†**ï¼Œä¿ç•™è‚¡ç¥¨çš„çº¯ä¸ªè‚¡ç‰¹è´¨ä¿¡å·ã€‚

```python
result = op.Neutralize(df, group_data)
```

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `df` | DataFrame | éœ€è¦ä¸­æ€§åŒ–çš„å› å­çŸ©é˜µ (T Ã— N) |
| `group_data` | Series æˆ– DataFrame | è¡Œä¸šæ˜ å°„ã€‚`Series(index=è‚¡ç¥¨ä»£ç , values=è¡Œä¸šå)`ï¼ˆæ¨èï¼‰|

**åŸç†ï¼š** å¯¹æ¯ä¸ªæ—¶é—´æˆªé¢ï¼Œä»¥è¡Œä¸šå“‘å˜é‡çŸ©é˜µä¸ºè‡ªå˜é‡åš OLS å›å½’ï¼Œå–**æ®‹å·®**ä½œä¸ºä¸­æ€§åŒ–åçš„å› å­å€¼ã€‚æ®‹å·®ä¸­ä¸å«è¡Œä¸šæ•´ä½“çš„æ¶¨è·Œä¿¡æ¯ï¼Œåªä¿ç•™ä¸ªè‚¡ç›¸å¯¹è¡Œä¸šçš„è¶…é¢è¡¨ç°ã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- é¿å…å› å­å¤§é‡æš´éœ²äºæŸä¸€è¡Œä¸šï¼ˆå¦‚ç§‘æŠ€è‚¡ã€é“¶è¡Œè‚¡ï¼‰å¯¼è‡´çš„è¡Œä¸š Beta
- ä½¿å› å­åœ¨è¡Œä¸šå†…éƒ¨åšæ¨ªå‘æ¯”è¾ƒï¼Œè€Œéè·¨è¡Œä¸šæ¯”è¾ƒ

```python
# é‡ä»·ç›¸å…³å› å­ï¼Œè¡Œä¸šä¸­æ€§åŒ–
raw_corr = op.Ts_Corr(data.volume, data.close, window=10)
factor_raw  = op.Rank(-raw_corr)

# ä¸­æ€§åŒ–ï¼šæ¶ˆé™¤è¡Œä¸šå…±æ€§
factor_neut = op.Neutralize(factor_raw, data.industry)

# ä¸­æ€§åŒ–åçš„å‡å€¼æ¥è¿‘ 0ï¼ˆè¡Œä¸šå†…å¤šç©ºå¹³è¡¡ï¼‰
print(factor_neut.mean(axis=1).mean())   # â‰ˆ 0
```

> **æ³¨æ„ï¼š** `Neutralize` å†…éƒ¨å«é€è¡Œå¾ªç¯ï¼ˆæ¯æ—¥åšä¸€æ¬¡ OLSï¼‰ï¼Œå¯¹è¶…é•¿æ—¶é—´åºåˆ—ï¼ˆ>2000å¤©ï¼‰é€Ÿåº¦è¾ƒæ…¢ã€‚

---

### 3. VectorEngine â€” å›æµ‹å¼•æ“

**å¯¼å…¥è·¯å¾„ï¼š** `from quant_alpha_engine.backtest import VectorEngine`

çŸ©é˜µå¼å‡€å€¼å›æµ‹å¼•æ“ï¼Œæ¥æ”¶å› å­çŸ©é˜µå’Œè¡Œæƒ…æ•°æ®ï¼Œè¾“å‡ºå®Œæ•´å›æµ‹ç»“æœã€‚

#### æ„é€ å‚æ•°

```python
VectorEngine(
    factor          = factor_df,     # å¿…å¡«ï¼šå› å­çŸ©é˜µ
    close           = close_df,      # å¿…å¡«ï¼šæ”¶ç›˜ä»·çŸ©é˜µ
    is_suspended    = susp_df,       # å¿…å¡«ï¼šåœç‰ŒçŸ©é˜µ
    is_limit        = limit_df,      # å¿…å¡«ï¼šæ¶¨è·ŒåœçŸ©é˜µ
    rebalance_freq  = 1,             # è°ƒä»“é¢‘ç‡ï¼ˆå¤©æ•°ï¼‰
    top_n           = 50,            # æŒä»“è‚¡ç¥¨æ•°
    weight_method   = 'equal',       # æƒé‡æ–¹å¼
    cost_rate       = 0.0015,        # å•è¾¹äº¤æ˜“æˆæœ¬
    initial_capital = 1_000_000.0,   # åˆå§‹èµ„é‡‘ï¼ˆä»…å±•ç¤ºç”¨ï¼‰
)
```

#### å‚æ•°è¯¦è§£

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `factor` | DataFrame | â€” | **å¿…å¡«**ã€‚å› å­çŸ©é˜µï¼ˆT Ã— Nï¼‰ï¼Œå€¼è¶Šå¤§ä»£è¡¨è¯¥è‚¡ç¥¨è¶Šåº”è¯¥è¢«ä¹°å…¥ |
| `close` | DataFrame | â€” | **å¿…å¡«**ã€‚æ”¶ç›˜ä»·çŸ©é˜µï¼ˆT Ã— Nï¼‰ï¼Œç”¨äºè®¡ç®—æ¯æ—¥æ”¶ç›Šç‡ |
| `is_suspended` | DataFrame | â€” | **å¿…å¡«**ã€‚åœç‰ŒçŸ©é˜µï¼ˆT Ã— Nï¼Œboolï¼‰ã€‚åœç‰Œè‚¡ç¥¨å½“æ—¥æƒé‡è‡ªåŠ¨ç½®é›¶ |
| `is_limit` | DataFrame | â€” | **å¿…å¡«**ã€‚æ¶¨è·ŒåœçŸ©é˜µï¼ˆT Ã— Nï¼Œboolï¼‰ã€‚æ¶¨è·Œåœè‚¡ç¥¨å½“æ—¥æƒé‡è‡ªåŠ¨ç½®é›¶ï¼ˆæ— æ³•æˆäº¤ï¼‰|
| `rebalance_freq` | int | 1 | è°ƒä»“é¢‘ç‡ã€‚`1`=æ¯æ—¥è°ƒä»“ï¼Œ`5`=æ¯å‘¨è°ƒä»“ï¼Œ`21`â‰ˆæ¯æœˆè°ƒä»“ã€‚éè°ƒä»“æ—¥æŒä»“ä¸å˜ |
| `top_n` | int | 50 | æ¯æ¬¡è°ƒä»“æ—¶ï¼ŒæŒ‰å› å­å€¼æ’åå–å‰ N åªè‚¡ç¥¨æŒä»“ã€‚è‹¥å¯äº¤æ˜“è‚¡ç¥¨ä¸è¶³ N åªï¼Œåˆ™å–å…¨éƒ¨å¯äº¤æ˜“è‚¡ç¥¨ |
| `weight_method` | str | `'equal'` | æŒä»“æƒé‡è®¡ç®—æ–¹å¼ï¼Œè§ä¸‹æ–¹è¯´æ˜ |
| `cost_rate` | float | 0.0015 | å•è¾¹äº¤æ˜“æˆæœ¬ç‡ï¼ˆæ‰‹ç»­è´¹ + æ»‘ç‚¹ï¼‰ã€‚æ¯æ¬¡æ¢æ‰‹çš„ä¹°å…¥æˆ–å–å‡ºå‡æŒ‰æ­¤æ¯”ç‡æ‰£è´¹ |
| `initial_capital` | float | 1,000,000 | åˆå§‹èµ„é‡‘ï¼Œä»…ç”¨äºç»“æœå±•ç¤ºï¼Œä¸å½±å“æ”¶ç›Šç‡è®¡ç®— |

**`weight_method` å¯é€‰å€¼ï¼š**

| å€¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|----|------|----------|
| `'equal'` | Top-N è‚¡ç¥¨ç­‰æƒæŒä»“ï¼Œæ¯åªæƒé‡ = 1/N | é»˜è®¤æ¨èï¼Œæ¶ˆé™¤è§„æ¨¡åå·® |
| `'factor_weighted'` | Top-N è‚¡ç¥¨æŒ‰å› å­ç»å¯¹å€¼åŠ æƒï¼ˆå½’ä¸€åŒ–åï¼‰ï¼Œå› å­å€¼è¶Šå¤§æƒé‡è¶Šé«˜ | å¸Œæœ›å› å­å¼ºä¿¡å·è‚¡ç¥¨è·å¾—æ›´é«˜é…ç½® |

**è°ƒä»“é¢‘ç‡å»ºè®®ï¼š**

| `rebalance_freq` | ç­‰æ•ˆé¢‘ç‡ | é€‚ç”¨å› å­ç±»å‹ |
|------------------|----------|-------------|
| 1 | æ¯æ—¥è°ƒä»“ | é«˜é¢‘åŠ¨é‡ã€é‡ä»·å› å­ |
| 5 | æ¯å‘¨è°ƒä»“ | ä¸­é¢‘æŠ€æœ¯å› å­ï¼ˆæ¨èèµ·ç‚¹ï¼‰|
| 21 | æ¯æœˆè°ƒä»“ | ä½é¢‘åŸºæœ¬é¢å› å­ |

#### æ–¹æ³•

```python
result = engine.run()   # æ‰§è¡Œå›æµ‹ï¼Œè¿”å› BacktestResult
```

`run()` ä¼šè‡ªåŠ¨ï¼š
1. å¯¹é½æ‰€æœ‰è¾“å…¥æ•°æ®ï¼ˆå–å…±åŒæ—¥æœŸå’Œè‚¡ç¥¨ï¼‰
2. è®¡ç®—å‰å‘ 1 æ—¥æ”¶ç›Šç‡ï¼ˆä¸¥æ ¼é˜²æœªæ¥å‡½æ•°ï¼‰
3. åœ¨è°ƒä»“æ—¥ç”Ÿæˆæƒé‡ï¼Œè¿‡æ»¤åœç‰Œ/æ¶¨è·Œåœè‚¡ç¥¨
4. è®¡ç®—æ¯æ—¥æ¢æ‰‹ç‡å’Œäº¤æ˜“æˆæœ¬
5. è®¡ç®—å‡€å€¼åºåˆ—å’Œå…¨é‡ç»©æ•ˆæŒ‡æ ‡

#### ä½¿ç”¨ç¤ºä¾‹

```python
from quant_alpha_engine.backtest import VectorEngine

# åŸºç¡€ç”¨æ³•ï¼ˆæ¯å‘¨è°ƒä»“ï¼Œç­‰æƒæŒä»“30åªï¼‰
engine = VectorEngine(
    factor         = factor,
    close          = data.close,
    is_suspended   = data.is_suspended,
    is_limit       = data.is_limit,
    rebalance_freq = 5,
    top_n          = 30,
    weight_method  = 'equal',
    cost_rate      = 0.0015,
)
result = engine.run()

# å› å­åŠ æƒ + ä½æ¢æ‰‹ï¼ˆæ¯æœˆè°ƒä»“ï¼‰
engine2 = VectorEngine(
    factor         = factor,
    close          = data.close,
    is_suspended   = data.is_suspended,
    is_limit       = data.is_limit,
    rebalance_freq = 21,
    top_n          = 20,
    weight_method  = 'factor_weighted',
    cost_rate      = 0.0010,   # æ›´ä½æˆæœ¬ï¼ˆæœºæ„è´¹ç‡ï¼‰
)
result2 = engine2.run()
```

---

### 4. BacktestResult â€” å›æµ‹ç»“æœå¯¹è±¡

`engine.run()` è¿”å›ä¸€ä¸ª `BacktestResult` æ•°æ®ç±»ï¼ŒåŒ…å«æ‰€æœ‰ä¸­é—´ç»“æœå’Œç»©æ•ˆæŒ‡æ ‡ï¼Œå¯ç›´æ¥ç”¨äºäºŒæ¬¡åˆ†æã€‚

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `result.nav` | Series | ç­–ç•¥å‡€å€¼åºåˆ—ï¼Œä» 1.0 å¼€å§‹ï¼Œindex=æ—¥æœŸ |
| `result.daily_returns` | Series | æ‰£é™¤äº¤æ˜“æˆæœ¬åçš„æ—¥æ”¶ç›Šç‡ |
| `result.gross_returns` | Series | æ‰£é™¤æˆæœ¬**å‰**çš„æ—¥æ”¶ç›Šç‡ï¼ˆæ¯›æ”¶ç›Šï¼‰|
| `result.cost_series` | Series | æ¯æ—¥å®é™…äº¤æ˜“æˆæœ¬ï¼ˆæ¢æ‰‹ç‡ Ã— cost_rateï¼‰|
| `result.weights` | DataFrame | æŒä»“æƒé‡çŸ©é˜µï¼ˆT Ã— Nï¼‰ï¼Œå·²å«å‰å‘å¡«å…… |
| `result.turnover` | Series | æ¯æ—¥å•è¾¹æ¢æ‰‹ç‡ = `sum(|w_t - w_{t-1}|) / 2` |
| `result.ic_series` | Series | æ¯æ—¥æˆªé¢ Rank IC å€¼ |
| `result.forward_returns` | DataFrame | å‰å‘1æ—¥æ”¶ç›Šç‡çŸ©é˜µï¼ˆT Ã— Nï¼‰|
| `result.factor` | DataFrame | å¯¹é½åçš„å› å­çŸ©é˜µï¼ˆT Ã— Nï¼‰|
| `result.metrics` | dict | æ‰€æœ‰ç»©æ•ˆæŒ‡æ ‡å­—å…¸ï¼ˆè§ä¸‹æ–¹æŒ‡æ ‡è¯´æ˜ï¼‰|
| `result.rebalance_dates` | list | å®é™…è°ƒä»“æ—¥æœŸåˆ—è¡¨ |

#### æ–¹æ³•

```python
result.print_summary()              # æ§åˆ¶å°æ‰“å° Unicode æ ¼å¼æŒ‡æ ‡è¡¨æ ¼
result.plot()                       # å¼¹çª—æ˜¾ç¤º 6 å­å›¾åˆ†ææŠ¥å‘Š
result.plot(save_path='out.png')    # ä¿å­˜æŠ¥å‘Šä¸º PNG æ–‡ä»¶ï¼ˆdpi=150ï¼‰
```

#### äºŒæ¬¡åˆ†æç¤ºä¾‹

```python
# æŸ¥çœ‹å‡€å€¼åºåˆ—
result.nav.plot(title='ç­–ç•¥å‡€å€¼')

# æŸ¥çœ‹æƒé‡åˆ†å¸ƒ
result.weights.sum(axis=1)   # æ¯æ—¥æ€»æƒé‡ï¼ˆåº”æ¥è¿‘1ï¼‰

# æ‰¾åˆ°æŒä»“æœ€å¤šçš„è‚¡ç¥¨
result.weights.mean().nlargest(10)   # å†å²å¹³å‡æƒé‡æœ€é«˜çš„10åªè‚¡ç¥¨

# æå– IC åºåˆ—åšç»Ÿè®¡
ic = result.ic_series.dropna()
print(f"IC å‡å€¼: {ic.mean():.4f}, ICIR: {ic.mean()/ic.std()*252**0.5:.3f}")

# è®¿é—®åŸå§‹æŒ‡æ ‡å­—å…¸
print(result.metrics['Sharpe_Ratio'])
print(result.metrics['IC_Mean'])

# è®¡ç®—ç´¯è®¡æˆæœ¬
cumcost = result.cost_series.cumsum()
```

---

### 5. Performance â€” ç»©æ•ˆæŒ‡æ ‡è®¡ç®—

**å¯¼å…¥è·¯å¾„ï¼š** `from quant_alpha_engine.backtest.performance import Performance`

ç‹¬ç«‹çš„ç»©æ•ˆè®¡ç®—å·¥å…·ç±»ï¼Œæ‰€æœ‰æ–¹æ³•ä¸ºé™æ€æ–¹æ³•ï¼Œå¯å¯¹ä»»æ„åºåˆ—è°ƒç”¨ï¼Œä¸ä¾èµ–å›æµ‹å¼•æ“ã€‚

#### æ–¹æ³•åˆ—è¡¨

---

##### `Performance.calc_annualized_return(nav)` â€” å¹´åŒ–æ”¶ç›Šç‡

```python
ann_ret = Performance.calc_annualized_return(nav)
# å…¬å¼ï¼š(nav_æœ« / nav_åˆ)^(252/T) - 1
```

| å‚æ•° | è¯´æ˜ |
|------|------|
| `nav` | å‡€å€¼åºåˆ—ï¼ˆpd.Seriesï¼Œä»1.0å¼€å§‹ï¼‰|

**è¿”å›ï¼š** floatï¼Œå¦‚ `0.15` è¡¨ç¤ºå¹´åŒ– 15%

---

##### `Performance.calc_annualized_volatility(returns)` â€” å¹´åŒ–æ³¢åŠ¨ç‡

```python
ann_vol = Performance.calc_annualized_volatility(returns)
# å…¬å¼ï¼šstd(r) * sqrt(252)
```

**è¿”å›ï¼š** floatï¼Œå¦‚ `0.20` è¡¨ç¤ºå¹´åŒ– 20%

---

##### `Performance.calc_sharpe(returns, risk_free=0.0, annualize=True)` â€” å¤æ™®æ¯”ç‡

```python
sharpe = Performance.calc_sharpe(returns, risk_free=0.03)
# å…¬å¼ï¼š(mean(r) - rf/252) / std(r) * sqrt(252)
```

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `returns` | â€” | æ—¥æ”¶ç›Šç‡åºåˆ— |
| `risk_free` | 0.0 | æ— é£é™©åˆ©ç‡ï¼ˆ**å¹´åŒ–**ï¼‰ï¼Œå¦‚ 0.03 è¡¨ç¤º 3% |
| `annualize` | True | æ˜¯å¦å¹´åŒ– |

**è¿”å›ï¼š** floatï¼Œè¶Šå¤§è¶Šå¥½ï¼ˆé€šå¸¸ >1 ä¸ºä¼˜ç§€ï¼Œ>2 ä¸ºå“è¶Šï¼‰

---

##### `Performance.calc_max_drawdown(nav)` â€” æœ€å¤§å›æ’¤

```python
mdd = Performance.calc_max_drawdown(nav)
# å…¬å¼ï¼šmin((nav_t - max(nav_{0..t})) / max(nav_{0..t}))
```

**è¿”å›ï¼š** floatï¼ˆ**è´Ÿæ•°**ï¼‰ï¼Œå¦‚ `-0.15` è¡¨ç¤ºæœ€å¤§å›æ’¤ -15%

---

##### `Performance.calc_calmar(nav)` â€” Calmar æ¯”ç‡

```python
calmar = Performance.calc_calmar(nav)
# å…¬å¼ï¼šå¹´åŒ–æ”¶ç›Šç‡ / |æœ€å¤§å›æ’¤|
```

**è¿”å›ï¼š** floatï¼Œè¡¡é‡å•ä½å›æ’¤é£é™©è·å¾—çš„å¹´åŒ–æ”¶ç›Šï¼Œè¶Šå¤§è¶Šå¥½

---

##### `Performance.calc_ic_series(factor, forward_returns)` â€” é€æ—¥ IC åºåˆ—

```python
ic_series = Performance.calc_ic_series(factor_df, fwd_ret_df)
```

| å‚æ•° | è¯´æ˜ |
|------|------|
| `factor` | å› å­çŸ©é˜µï¼ˆT Ã— Nï¼‰ |
| `forward_returns` | å¯¹åº”çš„å‰å‘æ”¶ç›ŠçŸ©é˜µï¼ˆT Ã— Nï¼‰ï¼Œé¡»ä¸ factor å¯¹é½ |

**IC è®¡ç®—æ–¹å¼ï¼š** æ¯æ—¥æˆªé¢ Rank IC = Spearman ç›¸å…³ç³»æ•°ï¼ˆå‘é‡åŒ–å®ç°ï¼Œç­‰ä»·äºå¯¹æ’ååçš„å› å­å’Œæ”¶ç›Šåš Pearson ç›¸å…³ï¼‰

**è¿”å›ï¼š** pd.Seriesï¼Œæ¯æ—¥çš„ IC å€¼ï¼Œindex=æ—¥æœŸ

---

##### `Performance.calc_ic_stats(ic_series)` â€” IC ç»Ÿè®¡æ‘˜è¦

```python
stats = Performance.calc_ic_stats(ic_series)
```

**è¿”å›å­—å…¸ï¼š**

| Key | è¯´æ˜ |
|-----|------|
| `IC_Mean` | IC å‡å€¼ï¼Œé€šå¸¸ä¼˜ç§€å› å­çš„ |IC| > 0.03 |
| `IC_Std` | IC æ ‡å‡†å·®ï¼Œåæ˜  IC ç¨³å®šæ€§ |
| `ICIR` | IC ä¿¡æ¯æ¯”ç‡ = IC_Mean / IC_Std Ã— âˆš252ï¼Œé€šå¸¸ >0.5 ä¸ºä¼˜ç§€ |
| `IC_Positive_Ratio` | IC > 0 çš„æ¯”ä¾‹ï¼ˆèƒœç‡ï¼‰ï¼Œé€šå¸¸ >55% ä¸ºä¼˜ç§€ |
| `IC_t_stat` | IC å‡å€¼çš„ t ç»Ÿè®¡é‡ï¼Œ|t| > 2 è¡¨ç¤ºç»Ÿè®¡æ˜¾è‘— |

---

##### `Performance.calc_turnover(weights)` â€” æ¢æ‰‹ç‡åºåˆ—

```python
turnover = Performance.calc_turnover(weights_df)
# å…¬å¼ï¼šsum(|w_t - w_{t-1}|) / 2
```

**è¿”å›ï¼š** pd.Seriesï¼Œæ¯æ—¥å•è¾¹æ¢æ‰‹ç‡ï¼ˆ0~1ä¹‹é—´ï¼Œå¦‚ 0.05 è¡¨ç¤º 5%ï¼‰

---

##### `Performance.calc_fitness(sharpe, nav, turnover)` â€” Fitness æŒ‡æ ‡

```python
fitness = Performance.calc_fitness(sharpe, nav, turnover)
# å…¬å¼ï¼šSharpe Ã— sqrt(|å¹´åŒ–æ”¶ç›Šç‡| / æ—¥å‡æ¢æ‰‹ç‡)
```

WorldQuant ç”¨äºç»¼åˆè¡¡é‡å› å­**æ”¶ç›Šè´¨é‡ Ã— ç¨³å®šæ€§ / æ¢æ‰‹æˆæœ¬**çš„ç»¼åˆæŒ‡æ ‡ã€‚

**è¿”å›ï¼š** floatï¼Œé€šå¸¸ >1.0 ä¸ºæœ‰ä»·å€¼çš„å› å­

---

##### `Performance.summary(...)` â€” å®Œæ•´æŒ‡æ ‡æ±‡æ€»

```python
metrics = Performance.summary(
    nav             = nav,
    daily_returns   = returns,
    weights         = weights,
    factor          = factor,
    forward_returns = fwd_ret,
    cost_series     = cost_series,   # å¯é€‰
)
```

**è¿”å›å­—å…¸ï¼ˆæ‰€æœ‰é”®åï¼‰ï¼š**

```python
{
    'å¹´åŒ–æ”¶ç›Šç‡': 0.1234,    # å¦‚ 0.1234 è¡¨ç¤º 12.34%
    'å¹´åŒ–æ³¢åŠ¨ç‡': 0.0856,
    'Sharpe_Ratio': 1.44,
    'Calmar_Ratio': 0.88,
    'æœ€å¤§å›æ’¤': -0.1567,     # è´Ÿæ•°
    'IC_Mean': 0.053,
    'IC_Std': 0.089,
    'ICIR': 1.23,
    'IC_èƒœç‡': 0.583,        # å¦‚ 0.583 è¡¨ç¤º 58.3%
    'IC_tç»Ÿè®¡é‡': 3.45,
    'æ—¥å‡æ¢æ‰‹ç‡': 0.056,
    'å¹´åŒ–æ‰‹ç»­è´¹': 0.0123,
    'Fitness': 0.89,
}
```

#### ç‹¬ç«‹ä½¿ç”¨ç¤ºä¾‹

```python
from quant_alpha_engine.backtest.performance import Performance
import pandas as pd

# å¯¹è‡ªå·±çš„æ”¶ç›Šåºåˆ—è®¡ç®—æŒ‡æ ‡
my_returns = pd.Series([0.001, -0.002, 0.003, ...], index=dates)
my_nav     = (1 + my_returns).cumprod()

sharpe = Performance.calc_sharpe(my_returns, risk_free=0.03)
mdd    = Performance.calc_max_drawdown(my_nav)
print(f"Sharpe: {sharpe:.3f}, MaxDD: {mdd*100:.1f}%")

# è®¡ç®— IC
ic = Performance.calc_ic_series(my_factor, my_fwd_returns)
stats = Performance.calc_ic_stats(ic)
print(f"IC å‡å€¼: {stats['IC_Mean']:.4f}, ICIR: {stats['ICIR']:.3f}")
```

---

### 6. Report â€” å¯è§†åŒ–æŠ¥å‘Š

**å¯¼å…¥è·¯å¾„ï¼š** `from quant_alpha_engine.visualization.report import Report`

é€šå¸¸é€šè¿‡ `result.plot()` é—´æ¥è°ƒç”¨ï¼Œä¹Ÿå¯ç›´æ¥è°ƒç”¨ `Report.plot(result)`ã€‚

#### `Report.plot(result, save_path=None, benchmark_seed=2024)`

```python
Report.plot(result)                            # å¼¹çª—å±•ç¤º
Report.plot(result, save_path='report.png')    # ä¿å­˜ä¸º PNGï¼ˆdpi=150ï¼‰
Report.plot(result, benchmark_seed=42)         # æŒ‡å®šåŸºå‡†éšæœºç§å­
```

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `result` | â€” | BacktestResult å¯¹è±¡ |
| `save_path` | None | ä¿å­˜è·¯å¾„ï¼ˆå¦‚ `'./output/factor1.png'`ï¼‰ã€‚ä¸º None æ—¶å¼¹çª—å±•ç¤º |
| `benchmark_seed` | 2024 | æ¨¡æ‹ŸåŸºå‡†ï¼ˆéšæœºæ¸¸èµ°ï¼‰çš„éšæœºç§å­ï¼Œå›ºå®šåæ¯æ¬¡åŸºå‡†ç›¸åŒ |

#### 6 å­å›¾å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ˆ å‡€å€¼æ›²çº¿     â”‚  ğŸ—“ï¸ æœˆåº¦æ”¶ç›Šçƒ­åŠ›å›¾ â”‚   ğŸ“Š IC æ—¶åº      â”‚
â”‚  ç­–ç•¥ vs åŸºå‡†    â”‚   è¡Œ=å¹´ï¼Œåˆ—=æœˆ    â”‚  æ­£ç»¿è´Ÿçº¢ + å‡å€¼çº¿ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“‰ æ—¥æ”¶ç›Šç‡åˆ†å¸ƒ â”‚   ğŸ”„ æ¢æ‰‹ç‡åºåˆ—   â”‚   ğŸ“ IC åˆ†å¸ƒ      â”‚
â”‚  ç›´æ–¹å›¾+KDE+æ­£æ€ â”‚  æŠ˜çº¿+å‡å€¼+è°ƒä»“æ—¥ â”‚ ç›´æ–¹å›¾+æ­£æ€+èƒœç‡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  é¡¶éƒ¨æŒ‡æ ‡æ‘˜è¦æ¡ï¼ˆ8é¡¹æ ¸å¿ƒæŒ‡æ ‡ï¼‰
```

| å­å›¾ | å†…å®¹ | å…³é”®ä¿¡æ¯ |
|------|------|----------|
| å‡€å€¼æ›²çº¿ | ç­–ç•¥å‡€å€¼ï¼ˆçº¢ï¼‰+ æ¨¡æ‹ŸåŸºå‡†ï¼ˆç°è™šçº¿ï¼‰+ å›æ’¤é˜´å½± | æœ€å¤§å›æ’¤æ ‡æ³¨ç®­å¤´ |
| æœˆåº¦æ”¶ç›Šçƒ­åŠ›å›¾ | æ¯æœˆæ”¶ç›Šç‡ï¼Œçº¢ç»¿é…è‰²ï¼ˆç»¿=æ­£æ”¶ç›Šï¼Œçº¢=è´Ÿæ”¶ç›Šï¼‰| ç›´è§‚çœ‹å­£èŠ‚æ€§è§„å¾‹ |
| IC æ—¶åº | æ¯æ—¥ IC æŸ±çŠ¶å›¾ï¼ˆæ­£ç»¿è´Ÿçº¢ï¼‰+ IC å‡å€¼è™šçº¿ | å·¦ä¸Šè§’æ ‡æ³¨ ICIR |
| æ—¥æ”¶ç›Šç‡åˆ†å¸ƒ | å®é™…åˆ†å¸ƒç›´æ–¹å›¾ + KDE + æ­£æ€åˆ†å¸ƒå¯¹æ¯”æ›²çº¿ | å°–å³°åšå°¾ç‰¹å¾ |
| æ¢æ‰‹ç‡åºåˆ— | éé›¶æ¢æ‰‹ç‡æŠ˜çº¿ + å‡å€¼è™šçº¿ + è°ƒä»“æ—¥æ ‡è®°ï¼ˆç°è‰²ç«–çº¿ï¼‰| äº†è§£æˆæœ¬èŠ‚å¥ |
| IC åˆ†å¸ƒ | IC å€¼åˆ†å¸ƒç›´æ–¹å›¾ + æ­£æ€æ‹Ÿåˆ + èƒœç‡æ ‡æ³¨ | IC åˆ†å¸ƒåæ­£æ€§ |

---

## æŒ‡æ ‡è¯´æ˜

| æŒ‡æ ‡ | è®¡ç®—å…¬å¼ | å‚è€ƒèŒƒå›´ | å«ä¹‰ |
|------|----------|----------|------|
| å¹´åŒ–æ”¶ç›Šç‡ | `(nav_æœ«/nav_åˆ)^(252/T) - 1` | >5% | ç­–ç•¥å¹´åŒ–è¶…é¢æ”¶ç›Š |
| å¹´åŒ–æ³¢åŠ¨ç‡ | `std(æ—¥æ”¶ç›Š) Ã— âˆš252` | <20% | æ”¶ç›Šçš„ä¸ç¨³å®šç¨‹åº¦ |
| **Sharpe Ratio** | `å¹´åŒ–è¶…é¢æ”¶ç›Š / å¹´åŒ–æ³¢åŠ¨ç‡` | **>1.0** | é£é™©è°ƒæ•´åæ”¶ç›Šï¼Œè¶Šé«˜è¶Šå¥½ |
| Calmar Ratio | `å¹´åŒ–æ”¶ç›Šç‡ / \|æœ€å¤§å›æ’¤\|` | >0.5 | å•ä½å›æ’¤é£é™©çš„å¹´åŒ–æ”¶ç›Š |
| **æœ€å¤§å›æ’¤** | `min((nav_t - nav_é«˜ç‚¹) / nav_é«˜ç‚¹)` | **>-30%** | å†å²æœ€å¤§äºæŸå¹…åº¦ï¼Œè¶Šå°è¶Šå¥½ |
| **IC å‡å€¼** | æ¯æ—¥ Rank IC çš„å‡å€¼ | **>0.03** | å› å­é¢„æµ‹åŠ›ï¼Œè¶Šé«˜è¶Šå¥½ |
| IC æ ‡å‡†å·® | æ¯æ—¥ IC çš„æ ‡å‡†å·® | â€” | IC ç¨³å®šæ€§ï¼Œè¶Šä½è¶Šå¥½ |
| **ICIR** | `ICå‡å€¼ / ICæ ‡å‡†å·® Ã— âˆš252` | **>0.5** | IC ä¿¡æ¯æ¯”ç‡ï¼Œç»¼åˆè¡¡é‡ç¨³å®šé¢„æµ‹åŠ› |
| IC èƒœç‡ | IC > 0 çš„å¤©æ•°å æ¯” | >55% | å› å­æ–¹å‘æ­£ç¡®çš„æ¦‚ç‡ |
| IC t-stat | IC å‡å€¼çš„ t ç»Ÿè®¡é‡ | `\|t\|>2` | IC ç»Ÿè®¡æ˜¾è‘—æ€§ï¼Œ>2 è¡¨ç¤ºæ˜¾è‘— |
| æ—¥å‡æ¢æ‰‹ç‡ | `mean(Î£\|w_t - w_{t-1}\| / 2)` | <10% | æ¯æ—¥å¹³å‡æ¢æ‰‹æ¯”ä¾‹ï¼Œè¶Šä½æˆæœ¬è¶Šå° |
| å¹´åŒ–æ‰‹ç»­è´¹ | `æ—¥å‡äº¤æ˜“æˆæœ¬ Ã— 252` | â€” | æ¯å¹´å› äº¤æ˜“æŸè€—çš„æ”¶ç›Š |
| **Fitness** | `Sharpe Ã— âˆš(\|å¹´åŒ–æ”¶ç›Š\| / æ—¥å‡æ¢æ‰‹)` | **>1.0** | WorldQuant ç»¼åˆè¯„ä¼°æŒ‡æ ‡ |

---

## ä½¿ç”¨çœŸå®æ•°æ®

å°†æ¡†æ¶åº”ç”¨åˆ°çœŸå®æ•°æ®æ—¶ï¼Œåªéœ€å°†æ•°æ®ç»„ç»‡ä¸ºæ­£ç¡®æ ¼å¼çš„ DataFrameï¼š

### æ•°æ®æ ¼å¼è¦æ±‚

```python
# æ‰€æœ‰ DataFrame é¡»æ»¡è¶³ï¼š
# - index: pd.DatetimeIndexï¼Œæ—¶é—´å‡åº
# - columns: è‚¡ç¥¨ä»£ç ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œå‘½åä¸€è‡´

import pandas as pd

# ä»·æ ¼æ•°æ®ï¼ˆT Ã— Nï¼‰
close = pd.DataFrame(...)    # index=æ—¥æœŸ, columns=è‚¡ç¥¨ä»£ç 

# åœç‰ŒçŸ©é˜µï¼ˆT Ã— Nï¼‰ï¼Œbool ç±»å‹
is_suspended = pd.DataFrame(...).astype(bool)

# æ¶¨è·ŒåœçŸ©é˜µï¼ˆT Ã— Nï¼‰ï¼Œbool ç±»å‹
# å¯ä»¥åˆå¹¶æ¶¨åœå’Œè·Œåœï¼šis_limit = is_limit_up | is_limit_down
is_limit = (is_limit_up | is_limit_down).astype(bool)

# è¡Œä¸šæ˜ å°„ï¼ˆé™æ€ï¼‰
# index=è‚¡ç¥¨ä»£ç , values=è¡Œä¸šåç§°å­—ç¬¦ä¸²
industry = pd.Series({
    '000001.SZ': 'é“¶è¡Œ',
    '000002.SZ': 'æˆ¿åœ°äº§',
    ...
})
```

### å®Œæ•´æ›¿æ¢æ¨¡æ¿

```python
import pandas as pd
from quant_alpha_engine.ops import AlphaOps as op
from quant_alpha_engine.backtest import VectorEngine

# â”€â”€ åŠ è½½æ‚¨çš„æ•°æ® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
close        = pd.read_csv('close.csv',        index_col=0, parse_dates=True)
volume       = pd.read_csv('volume.csv',       index_col=0, parse_dates=True)
is_suspended = pd.read_csv('suspended.csv',    index_col=0, parse_dates=True).astype(bool)
is_limit_up  = pd.read_csv('limit_up.csv',     index_col=0, parse_dates=True).astype(bool)
is_limit_dn  = pd.read_csv('limit_down.csv',   index_col=0, parse_dates=True).astype(bool)
is_limit     = is_limit_up | is_limit_dn

industry     = pd.read_csv('industry.csv', index_col=0).squeeze()  # Series

# â”€â”€ æ„é€ æ‚¨çš„å› å­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
factor = op.Neutralize(
    op.Rank(-op.Ts_Corr(volume, close, window=10)),
    industry
)

# â”€â”€ ä¸€è¡Œå›æµ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
result = VectorEngine(
    factor         = factor,
    close          = close,
    is_suspended   = is_suspended,
    is_limit       = is_limit,
    rebalance_freq = 5,
    top_n          = 50,
    weight_method  = 'equal',
    cost_rate      = 0.0015,
).run()

result.print_summary()
result.plot(save_path='my_factor_report.png')
```

---

## å› å­æ„é€ ç¤ºä¾‹é›†

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºå¸¸è§å› å­ç±»å‹çš„ç®—å­ç»„åˆæ–¹å¼ï¼Œå¯ç›´æ¥å¤ç”¨æˆ–å‚è€ƒä¿®æ”¹ï¼š

```python
from quant_alpha_engine.ops import AlphaOps as op

# â”€â”€ åè½¬ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# çŸ­æœŸåè½¬ï¼ˆ5æ—¥ï¼‰
factor_rev5 = op.Rank(-op.Ts_Delta(close, 5))

# ä¸­æœŸåè½¬ï¼ˆ20æ—¥ï¼‰+ è¡Œä¸šä¸­æ€§åŒ–
factor_rev20 = op.Neutralize(op.Rank(-op.Ts_Delta(close, 20)), industry)

# â”€â”€ åŠ¨é‡ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# æœˆåº¦åŠ¨é‡ï¼ˆè·³è¿‡æœ€è¿‘5å¤©ï¼Œé¿å…çŸ­æœŸåè½¬ï¼‰
momentum = close / op.Ts_Delay(close, 21) - close / op.Ts_Delay(close, 5)
factor_mom = op.Rank(momentum)

# çº¿æ€§è¡°å‡å¹³æ»‘çš„åŠ¨é‡
factor_decay_mom = op.Rank(op.Decay_Linear(op.Rank(op.Ts_Delta(close, 10)), d=5))

# â”€â”€ é‡ä»·ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# é‡ä»·èƒŒç¦»ï¼ˆç¼©é‡ä¸Šæ¶¨ä¸ºæ­£ä¿¡å·ï¼‰
factor_vp = op.Neutralize(op.Rank(-op.Ts_Corr(volume, close, 10)), industry)

# æˆäº¤é‡æ—¶åºåˆ†ä½ï¼ˆè¿‘æœŸæˆäº¤é‡å¤„äºå†å²ä½ä½ï¼‰
factor_vol_rank = op.Rank(-op.Ts_Rank(volume, 20))

# æ”¾é‡åˆ›æ–°é«˜ï¼ˆä»·æ ¼åˆ›æ–°é«˜ + æˆäº¤é‡ä¹Ÿåˆ›é«˜ï¼‰
price_rank  = op.Ts_Rank(close, 60)
vol_rank    = op.Ts_Rank(volume, 20)
factor_breakout = op.Rank(price_rank + vol_rank)

# â”€â”€ æ³¢åŠ¨ç‡ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# ä½æ³¢åŠ¨å› å­ï¼ˆæ³¢åŠ¨ç‡è¶Šå°è¶Šå¥½ï¼‰
daily_ret = close.pct_change()
factor_lowvol = op.Rank(-op.Ts_Std(daily_ret, 20))

# â”€â”€ ä»·æ ¼ä½ç½®ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Williams %Rï¼ˆä»·æ ¼åœ¨è¿‘20æ—¥åŒºé—´å†…çš„ä½ç½®ï¼Œè¶Šä½è¶Šè¶…å–ï¼‰
high20 = op.Ts_Max(high, 20)
low20  = op.Ts_Min(low,  20)
wr     = (close - high20) / (high20 - low20 + 1e-8)
factor_wr = op.Rank(-wr)   # è¶…å–æ’åé å‰

# â”€â”€ å¤šå› å­åˆæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# ç­‰æƒåˆæˆï¼ˆå…ˆåˆ†åˆ« Rank æ¶ˆé™¤é‡çº²ï¼Œå†åŠ æƒï¼‰
alpha_combo = (
    0.4 * op.Rank(factor_rev5) +
    0.3 * op.Rank(factor_vp) +
    0.3 * op.Rank(factor_lowvol)
)
```

---

## å¸¸è§é—®é¢˜

**Q: å›æµ‹æ—¶æç¤º `æ•°æ®è§„æ¨¡ï¼šN ä¸ªäº¤æ˜“æ—¥ Ã— M åªè‚¡ç¥¨`ï¼ŒM æ¯”é¢„æœŸå°‘ï¼Ÿ**

A: `VectorEngine` ä¼šè‡ªåŠ¨å– `factor`ã€`close`ã€`is_suspended`ã€`is_limit` å››ä¸ªè¾“å…¥çš„**å…±åŒè‚¡ç¥¨åˆ—äº¤é›†**ã€‚è¯·æ£€æŸ¥å„ DataFrame çš„ columns æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆå¤§å°å†™ã€æ ¼å¼éœ€ç›¸åŒï¼‰ã€‚

---

**Q: `Ts_Rank` è¿è¡Œå¾ˆæ…¢ï¼Ÿ**

A: `Ts_Rank` å†…éƒ¨ä½¿ç”¨ `rolling.apply`ï¼ˆPython å±‚å¾ªç¯ï¼‰ï¼Œå¯¹å¤§çŸ©é˜µæ€§èƒ½æœ‰é™ã€‚ä¼˜åŒ–å»ºè®®ï¼š
1. å‡å°‘è‚¡ç¥¨æ•°é‡æˆ–ç¼©çŸ­æ—¶é—´åºåˆ—
2. å°† `window` æ§åˆ¶åœ¨ 60 ä»¥å†…
3. è€ƒè™‘ç”¨ `Rank(df)` æ›¿ä»£ï¼ˆæˆªé¢æ’åé€Ÿåº¦æ›´å¿«ï¼‰

---

**Q: æƒ³å¯¹å› å­åš IC åˆ†æï¼Œä½†ä¸æƒ³èµ°å®Œæ•´å›æµ‹æµç¨‹ï¼Ÿ**

A: ç›´æ¥ä½¿ç”¨ `Performance` æ¨¡å—ï¼š

```python
from quant_alpha_engine.backtest.performance import Performance

# è®¡ç®—å‰å‘1æ—¥æ”¶ç›Šç‡
fwd_ret = close.shift(-1) / close - 1

# è®¡ç®— IC åºåˆ—
ic = Performance.calc_ic_series(my_factor, fwd_ret)
stats = Performance.calc_ic_stats(ic)
print(stats)
```

---

**Q: å¦‚ä½•ä¿å­˜å›æµ‹æŠ¥å‘Šå›¾ç‰‡ï¼Ÿ**

```python
result.plot(save_path='./reports/factor1_report.png')
# æˆ–
from quant_alpha_engine.visualization.report import Report
Report.plot(result, save_path='./reports/factor1_report.png')
```

---

**Q: `Neutralize` ä¸­æ€§åŒ–åå› å­å‡å€¼ä¸ä¸ºé›¶ï¼Ÿ**

A: æ­£å¸¸ç°è±¡ã€‚`Neutralize` ä½¿ç”¨ OLS æ®‹å·®ï¼Œæ®‹å·®åœ¨æ¯ä¸ªè¡Œä¸šå†…å‡å€¼ä¸ºé›¶ï¼Œä½†**è·¨è¡Œä¸šçš„æ•´ä½“å‡å€¼**ä¸ä¸€å®šä¸ºé›¶ã€‚è‹¥éœ€æ•´ä½“å‡å€¼ä¸ºé›¶ï¼Œå¯åœ¨ä¸­æ€§åŒ–åå†åšä¸€æ¬¡ `ZScore`ï¼š

```python
factor_neut = op.Neutralize(raw_factor, industry)
factor_final = op.ZScore(factor_neut)   # ç¡®ä¿æˆªé¢å‡å€¼=0
```

---

**Q: å¦‚ä½•æ¨¡æ‹Ÿä¸åŒå¸‚åœºç¯å¢ƒï¼ˆç‰›å¸‚/ç†Šå¸‚/éœ‡è¡ï¼‰ï¼Ÿ**

```python
# ç‰›å¸‚ï¼ˆé«˜æ¼‚ç§» + ä½æ³¢åŠ¨ï¼‰
bull = MockDataGenerator(mu=0.20, sigma=0.18, seed=1).generate()

# ç†Šå¸‚ï¼ˆè´Ÿæ¼‚ç§» + é«˜æ³¢åŠ¨ï¼‰
bear = MockDataGenerator(mu=-0.10, sigma=0.45, seed=2).generate()

# éœ‡è¡å¸‚ï¼ˆé›¶æ¼‚ç§» + ä¸­ç­‰æ³¢åŠ¨ï¼‰
flat = MockDataGenerator(mu=0.00, sigma=0.25, seed=3).generate()
```

---

**Q: å¦‚ä½•åœ¨ Jupyter Notebook ä¸­ä¿å­˜å›¾è¡¨è€Œä¸å¼¹çª—ï¼Ÿ**

```python
import matplotlib
matplotlib.use('Agg')   # åœ¨ import pyplot ä¹‹å‰è®¾ç½®éäº¤äº’åç«¯

result.plot(save_path='report.png')
```

æˆ–åœ¨ Notebook é¡¶éƒ¨ä½¿ç”¨ `%matplotlib inline` æ—¶ï¼Œç›´æ¥ç”¨ `save_path` å‚æ•°ä¿å­˜ã€‚
